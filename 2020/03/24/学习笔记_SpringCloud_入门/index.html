<!DOCTYPE html><html class="theme-next pisces use-motion" lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2"><link rel="stylesheet" href="/css/main.css?v=7.1.2"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.2"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.2"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.2"><link rel="mask-icon" href="/images/logo.svg?v=7.1.2" color="#222"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"7.1.2",sidebar:{position:"left",display:"post",offset:12,onmobile:!1,dimmer:!1},back2top:!0,back2top_sidebar:!0,fancybox:!1,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><script></script><meta name="description" content="SpringCloudの笔记"><meta name="keywords" content="学习笔记,java,SpringCloud"><meta property="og:type" content="article"><meta property="og:title" content="学习笔记_SpringCloud_入门"><meta property="og:url" content="https://robotwuyun.github.io/2020/03/24/学习笔记_SpringCloud_入门/index.html"><meta property="og:site_name" content="但行好事,莫问前程"><meta property="og:description" content="SpringCloudの笔记"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2020-03-29T12:32:56.044Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="学习笔记_SpringCloud_入门"><meta name="twitter:description" content="SpringCloudの笔记"><link rel="canonical" href="https://robotwuyun.github.io/2020/03/24/学习笔记_SpringCloud_入门/"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>学习笔记_SpringCloud_入门 | 但行好事,莫问前程</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><script type="text/javascript" src="/js/src/clicklove.js"></script><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div> <a href="https://github.com/RobotWuYun" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">但行好事,莫问前程</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">记录学习的技能和遇到的问题</p></div><div class="site-nav-toggle"> <button aria-label="切换导航栏"><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://robotwuyun.github.io/2020/03/24/学习笔记_SpringCloud_入门/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="上课睡觉觉"><meta itemprop="description" content="keep learning"><meta itemprop="image" content="/image/headPic.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="但行好事,莫问前程"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">学习笔记_SpringCloud_入门</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-03-24 22:08:13" itemprop="dateCreated datePublished" datetime="2020-03-24T22:08:13+08:00">2020-03-24</time> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2020-03-29 20:32:56" itemprop="dateModified" datetime="2020-03-29T20:32:56+08:00">2020-03-29</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/SpringBoot学习笔记/" itemprop="url" rel="index"><span itemprop="name">SpringBoot学习笔记</span></a></span></span> <span class="post-comments-count"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span> <span class="post-meta-item-text">评论数：</span><a href="/2020/03/24/学习笔记_SpringCloud_入门/#comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2020/03/24/学习笔记_SpringCloud_入门/" itemprop="commentCount"></span></a></span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i> 热度：<span class="busuanzi-value" id="busuanzi_value_page_pv"></span> <span>℃</span></span></div></header><div class="post-body" itemprop="articleBody"><center> SpringCloudの笔记<br></center><a id="more"></a><h1 id="SpringCloud"><a href="#SpringCloud" class="headerlink" title="SpringCloud"></a>SpringCloud</h1><h3 id="系统架构演变"><a href="#系统架构演变" class="headerlink" title="系统架构演变"></a>系统架构演变</h3><h4 id="集中式架构"><a href="#集中式架构" class="headerlink" title="集中式架构"></a>集中式架构</h4><p>所有的功能在一个项目中开发.</p><ul><li><p>优点</p><ul><li>结构简单</li></ul></li><li><p>缺点</p><ul><li>代码耦合度高</li><li>无法针对不同模块进行针对性优化</li><li>无法水平拓展</li><li>单点容错性率低,并发能力差</li></ul></li></ul><h4 id="垂直划分"><a href="#垂直划分" class="headerlink" title="垂直划分"></a>垂直划分</h4><p>按功能划分成各个子项目</p><ul><li>优点<ul><li>系统拆分实现流量分担,解决了并发问题</li><li>可以针对不同模块进行优化</li><li>方便水平扩展,负载均衡,容错率提高</li></ul></li><li>缺点<ul><li>系统之间相互独立,会有很多重复工作,影响开发效率</li></ul></li></ul><h4 id="分布式服务"><a href="#分布式服务" class="headerlink" title="分布式服务"></a>分布式服务</h4><p>将垂直划分后的功能中的重复的地方抽取出来搭建底层,上层应用调用他们.</p><ul><li>优点<ul><li>提高了代码的重用率和开发效率</li></ul></li><li>缺点<ul><li>系统之间的耦合度变高,调用关系错综复杂,难以维护</li></ul></li></ul><h4 id="流动计算架构-SOA"><a href="#流动计算架构-SOA" class="headerlink" title="流动计算架构(SOA)"></a>流动计算架构(SOA)</h4><p>SOA:面向服务的架构</p><p>当服务越来越多,容量的评估,小服务资源的浪费问题逐渐显现,此时需增加一个调度中心基于访问压力实时管理集群容量,提高集群利用率.此时,用于提高机器利用率的资源调度和治理中心(SOA)是关键.</p><p>服务治理要做什么?</p><ul><li>服务注册中心,实现服务自主注册和发现,无需人为记录服务地址</li><li>服务自动订阅,服务列表自动推送,服务调用透明化,无需关系依赖关系</li><li>动态监控报告,人为控制服务状态</li></ul><p>缺点:</p><ul><li>服务间会有依赖关系,一旦某个环节出错会影响较大</li><li>服务关系复杂,运维,测试部署困难,不符合DevOps思想</li></ul><h4 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h4><p>特点:</p><ul><li>单一职责:微服务中每一个服务都对应唯一的业务能力,做到单一职责.</li><li>微:微服务的服务拆分粒度很小,例如一个用户管理就可以作为一个服务,每个服务虽小,但”五脏俱全”</li><li>面向服务:每个服务都要对外暴露Rest风格服务接口API并不关心服务的技术实现,做到与平台和语言无关,也不限定用什么技术实现,只要提供Rest的接口即可.</li><li>自治:<ul><li>团队独立:每个服务都是一个独立的团队开发</li><li>技术独立:因为是面向服务,提供Rest接口,使用什么技术没用别人干涉</li><li>前后端分离:采用前后端分离开发,提供统一Rest接口,后端不同再为PC,移动端开发不同接口.</li><li>数据库分离:每个服务都可以使用自己的数据源</li><li>部署独立,服务间虽然有调用,但要做到服务重启不影响其他服务,有利于持续集成和持续交付.每个服务都是独立的组件,可复用,可替换,降低耦合,易维护.</li></ul></li></ul><h3 id="服务调用方式"><a href="#服务调用方式" class="headerlink" title="服务调用方式"></a>服务调用方式</h3><h4 id="RPC和HTTP"><a href="#RPC和HTTP" class="headerlink" title="RPC和HTTP"></a>RPC和HTTP</h4><p>常用的远程调用方式有以下2种:</p><ul><li><p>RPC:Remote Produce Call 远程过程调用,类似的还有RMI.自定义数据格式.基于原生TPC通信,速度快,效率高.早期的webservice,现在的热门dubbo,都是RPC的典型代表.</p></li><li><p>Http:http其实是一种网络传输协议,基于TCP,规定了数据传输的格式.现在客户端浏览器与服务端通信基本都是采用Http协议,也可以用来进行远程服务调用.缺点是消息封装臃肿,优势是对服务的提供和调用方没有任何技术限定,自由灵活.更符合微服务理念.</p><blockquote><p>现在热门的Rest风格,就可以通过http方式来实现服务间调用.</p><p>如果公司采用Java技术栈,那么Dubbo作为微服务架构是个不错的选择.如果公司的技术栈多样化,那么springCloud搭建微服务是不错的选择.</p></blockquote></li></ul><h4 id="HTTP客户端工具"><a href="#HTTP客户端工具" class="headerlink" title="HTTP客户端工具"></a>HTTP客户端工具</h4><p>自己实现Http对请求和响应的处理:</p><ul><li>HttpClient</li><li>OKHttp</li><li>httpUrlConnection</li></ul><p>不过这些不同的客户端有不同的API</p><h4 id="Spring的RestTemplate"><a href="#Spring的RestTemplate" class="headerlink" title="Spring的RestTemplate"></a>Spring的RestTemplate</h4><p>Spring提供了一个RestTemplate模板工具类,对基于Http的客户端进行了封装,并实现了对象与json的序列化和反序列化,非常方便,RestTemplate并没有限定Http的客户端类型,而是进行了抽象,目前常用的3种都有支持:</p><ul><li>HttpClient</li><li>OKHttp</li><li>JDK原生的HtpUrlConnection(默认的)</li></ul><h3 id="初始SpringCloud"><a href="#初始SpringCloud" class="headerlink" title="初始SpringCloud"></a>初始SpringCloud</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>SpringCloud是Spring旗下的项目之一</p><p>SpringCloud将现在非常流行的一些技术整合到一起,实现了诸如:配置管理,服务发现,智能路由,负载均衡,熔断器,控制总线,集群状态等等功能,其主要涉及的组件包括:</p><p>Netflix</p><ul><li>Eureka:注册中心</li><li>Zuul:服务开关</li><li>Ribbon:负载均衡</li><li>Feign:服务调用</li><li>Hystix:熔断器</li></ul><p>为了提高功能间调用访问的灵活性,可扩展性:所以我们需要 一个注册中心:</p><h3 id="Eureka注册中心"><a href="#Eureka注册中心" class="headerlink" title="Eureka注册中心"></a>Eureka注册中心</h3><h4 id="Eureka做什么"><a href="#Eureka做什么" class="headerlink" title="Eureka做什么?"></a>Eureka做什么?</h4><p>Eureka负责管理注册功能的信息,服务调用者无需自己寻找服务,而是把自己的需求告诉Eureka,然后Eureka会将符合条件的服务告诉你</p><p>同时,服务提供方与Eurake之间通过”心跳”机制进行监控,当某个服务提供方出现问题,Eureka自然会把它从服务列表中删除.</p><p>这样就实现了服务的自动注册,发现,状态监控</p><h4 id="基本架构"><a href="#基本架构" class="headerlink" title="基本架构"></a>基本架构</h4><ul><li>Eureka:就是服务注册中心(可以是一个集群),对外暴露自己的地址</li><li>提供者:启动后向Eurake注册自己的信息(地址,提供什么服务)</li><li>消费者:向Eureka订阅服务,Eurake会将对应服务的所有提供者地址列表发送给消费者,并定期更新</li><li>心跳(续约):提供者定期通过http方式向Eureka刷新自己的状态.</li></ul><h4 id="高可用的Eureka-Server"><a href="#高可用的Eureka-Server" class="headerlink" title="高可用的Eureka Server"></a>高可用的Eureka Server</h4><p>Eureka可以组成一个集群,形成高可用的Eureka中心.</p><blockquote><p>服务同步</p></blockquote><p>多个Eureka Server之间也会互相注册为服务,当服务提供者注册到Eureka Server集群中的某个节点时,该节点会把服务的信息同步给集群中的每个节点,从而实现<strong>数据同步</strong>.因此,无论客户端访问到Eureka Server集群中的任意一个节点,都可以获取到完整的服务列表信息.</p><p><strong>步骤:</strong></p><ol><li>修改旧的Eureka服务的端口和注册地址</li><li>复制一台并将端口和地址取反</li><li>启动测试</li><li>将其他服务呢注册到两台Eureka服务上(防止其中一台挂机)</li></ol><h4 id="Eureka客户端"><a href="#Eureka客户端" class="headerlink" title="Eureka客户端"></a>Eureka客户端</h4><p>服务提供者要向EurekaServer注册服务,并完成服务续约等工作.</p><blockquote><p>服务注册</p></blockquote><p>服务提供者在启动时,会检查配置属性中的:<code>eureka.client.register-with-eureka=true</code>参数是否正确(默认为true),如果值为true,则会向EurekaServer发起一个Rest请求,并携带自己的元数据信息,Eureka Server会白这些信息保存到一个双层的Map结构中 .</p><ul><li>第一层Map的key就是服务id,一般是配置中的<code>spring.application.name</code>属性</li><li>第二层Map的key是服务的实例id,一般host+serviceId+port,例如<code>localhost:user-service:8081</code></li><li>值是服务的实例对象,也就是说一个服务,可以同时启动多个不同实例,形成集群.</li></ul><blockquote><p>服务续约</p></blockquote><p>在注册完成服务以后,服务提供者会维持一个心跳(定时向EurekaServer发起Rest请求),告诉EurekaServer:”我还活着”.我们称之为续约(renew).</p><p>有两个重要参数可以修改服务续约的行为:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">eureka:</span><br><span class="line">	instance:</span><br><span class="line">		lease-renewal-interval-in-secinds:30</span><br><span class="line">		lease-expiration-duration-in-seconds:90</span><br></pre></td></tr></table></figure><ul><li><p>lease-renewal-interval-in-secinds:服务续约(renew)的间隔,默认为30秒</p></li><li><p>lease-expiration-duration-in-seconds:服务失效时间,默认90</p></li></ul><blockquote><p>获取服务列表</p></blockquote><p>当服务消费者启动时,会检测<code>eureka.client.fetch-registry=true</code>参数的值,如果为true,则会从Eureka Server服务的列表只读备份,然后缓存在本地.并且每隔30秒会重新获取并更新数据.可以通过下面的参数来修改:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eureka:</span><br><span class="line">	client:</span><br><span class="line">		registry-fetch-interval-seconds:30</span><br></pre></td></tr></table></figure><h4 id="失效剔除和自我保护"><a href="#失效剔除和自我保护" class="headerlink" title="失效剔除和自我保护"></a>失效剔除和自我保护</h4><blockquote><p>服务下线</p></blockquote><p>当服务进行正常关闭操作时,他会触发一个服务下线的REST请求给Eureka Server,告诉服务注册中心”我要下线了”,服务中心接收到请求之后,将该服务置为下线状态</p><blockquote><p>失效剔除</p></blockquote><p>有时我们的服务可能 由于内存溢出或网络故障等原因使得服务器不能正常工作,而服务注册中心并未收到”服务下线”的请求.相对于服务提供者的”服务续约”操作,服务注册中心在启动时会创建一个定时任务,默认每隔一点时间(默认60秒)将当前清单中超时(默认为90秒)没有续约的服务剔除,这个操作被称为失效剔除.</p><p>可以通过<code>eureka.server.eviction-interval-timer-in-ms</code>参数对其进行修改,单位是毫秒.</p><blockquote><p>自我保护</p></blockquote><p>当服务未按时进行续约时,Eureka会统计服务实例最近15分钟心跳续约的比例是否低于85%.</p><p>可以通过下面的配置来关停:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eureka:</span><br><span class="line">	server:</span><br><span class="line">		enable-self-preservation:false#关闭自我保护模式(缺省为打开)</span><br></pre></td></tr></table></figure><h3 id="负载均衡Ribbon"><a href="#负载均衡Ribbon" class="headerlink" title="负载均衡Ribbon"></a>负载均衡Ribbon</h3><p>为了在集群中选择合适的服务,所以需要负载均衡.</p><p>Eureka中已经集成了负载均衡组件:Ribbon.</p><blockquote><p>什么是Ribbon:</p><p>Ribbon是Netfix发布的负载均衡器,它有助于控制HTTP和TCP客户端的行为.为Ribbon配置服务提供者地址列表后,Ribbon就可基于某种负载均衡算法,自动地帮助服务消费者去请求.Ribbon默认提供了很多均衡算法,例如轮询,随机等.当然,也可以为Ribbon实现自定义的负载均衡算法.</p></blockquote><h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤:"></a>步骤:</h4><ol><li>引入Pom</li><li>在需要负载均衡的主程序的启动类上加上<code>@LoadBalanced</code></li><li>在服务消费者的请求中直接用服务的id作为地址访问</li></ol><h4 id="配置负载均衡算法"><a href="#配置负载均衡算法" class="headerlink" title="配置负载均衡算法"></a>配置负载均衡算法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[服务名]</span><br><span class="line">	ribbon:</span><br><span class="line">		NFLoadBalancerRuleClassName:[算法全类名]</span><br></pre></td></tr></table></figure><h3 id="Hystrix"><a href="#Hystrix" class="headerlink" title="Hystrix"></a>Hystrix</h3><h4 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h4><p>Hystrix,英文意思是豪猪,全身是刺,看起来就不好惹,是一种保护机制.</p><p>Hystrix也是Netflix公司的一款组件.</p><h4 id="雪崩问题"><a href="#雪崩问题" class="headerlink" title="雪崩问题"></a>雪崩问题</h4><p>微服务中,服务间调用的关系错综复杂,一个请求,可能需要多个微服务接口才能实现,会形成非常复杂的调用链路.当一个服务崩溃时,用户的请求就会得不到响应,则Tomcat的这个线程不会被释放,于是越来越多的用户请求被阻塞,Tomcat连接池就被占满了,从而导致其他的服务也都不可用,形成雪崩效应.</p><p>为了解决雪崩问题就需要Hystrix</p><p><strong>Hystrix解决雪崩问题的手段有两个:</strong></p><ul><li>线程隔离</li><li>服务熔断</li></ul><h4 id="线程隔离-服务降级"><a href="#线程隔离-服务降级" class="headerlink" title="线程隔离,服务降级"></a>线程隔离,服务降级</h4><h5 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h5><p>将总线程池拆分成小的线程池分配给不同的服务.这样就只会耗尽崩溃线程的线程池.</p><p>并且设置超时时长,当服务超过超时时长时,返回一个失败的信号.然后快速失败,释放线程.</p><blockquote><p> 服务降级:优先保证核心服务,而非核心服务不可用或弱可用</p></blockquote><p><strong>触发Hystrix服务降级的情况:</strong></p><ul><li>线程池已满</li><li>请求超时</li></ul><blockquote><p><strong>注意:</strong>服务的降级是在消费方</p></blockquote><h5 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤"></a>步骤</h5><ol><li>pom.xml中引入Hystrix依赖</li><li>在启动类中添加注解</li><li>在配置文件中配置 (可选)</li><li>编写失败处理<ul><li>在controller层添加失败处理注解</li><li>分别完成失败和成功的处理方法.</li></ul></li></ol><h4 id="服务熔断"><a href="#服务熔断" class="headerlink" title="服务熔断"></a>服务熔断</h4><h5 id="熔断原理"><a href="#熔断原理" class="headerlink" title="熔断原理"></a>熔断原理</h5><p>熔断器,也叫断路器</p><blockquote><p>熔断机制就像家里的的电路熔断器,如果电路发生了短路能立刻熔断电路,避免发生灾难,在分布式系统中应用这一模式之后,服务调用方可以自己进行判断某些服务反应慢或者存在大量超时情况时,能够主动熔断,防止整个系统被拖垮.</p><p>不同于电路熔断只能断不能自动重连,Hystrix可以实现弹性容错,当情况好转之后,可以自动重连.</p><p>通过断路的方式.可以将后续请求直接拒绝掉,一段时间之后允许部分请求通过,如果调用成功则回到电路闭合状态,否则继续断开.</p></blockquote><p>状态机有3个状态:</p><ul><li>Closed:关闭状态(断路器关闭),所有请求都能正常访问.</li><li>Open:打开状态(断路器打开),所以请求都会被降级.Hystix会对请求情况计数,当一定时间内失败请求百分比达到阈值,则出发熔断,断路器会完全关闭,默认失败比例的阈值是50%,请求次数最少不低于20次.</li><li>Half Open:半开状态,Closed状态不是永久的,关闭后会进入休眠时间(默认是5s).随后断路器会自动进入半开状态,此时会释放部分请求通过,若这些请求都是健康的,则会完全打开断路器,否则继续保持关闭,再次进行休眠即时.</li></ul><p>几个有关参数:</p><ul><li>requestVolumeThreshold:触发熔断的最小请求次数,默认为20</li><li>errorThresholdPercentage:触发熔断的失败请求最小占比,默认50%</li><li>sleepWindowInMillseconds:休眠时长,默认是5000毫秒</li></ul><h3 id="Feign"><a href="#Feign" class="headerlink" title="Feign"></a>Feign</h3><p>Feign可以把Rest的请求进行隐藏,伪装成类似SpringMVC的Controller一样.不在需要自己拼接url,拼接参数等等操作,一切交给Feign去做.</p><blockquote><p>同时Feign还实现了负载均衡和熔断机制,可以通过配置修改相关属性,也支持Hystix,需要配置开启,还支持请求压缩, 日志级别等</p></blockquote><h4 id="步骤-2"><a href="#步骤-2" class="headerlink" title="步骤"></a>步骤</h4><ol><li>引入依赖<code>openfeign</code></li><li>在服务消费方添加注解<code>@EnableFeignClients</code></li><li>编写接口</li></ol><h3 id="Zuul网关"><a href="#Zuul网关" class="headerlink" title="Zuul网关"></a>Zuul网关</h3><h4 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h4><p>Zuul上古NetFlix开源的微服务网关,它可以和Eureka,Ribbon,Hystrix等组件配合使用.</p><p>Zuul的核心是一系列的过滤器,这些过滤器可以完成以下功能:</p><ul><li>身份认证与安全:识别每个资源的验证要求,并拒绝那些与要求不符的请求.</li><li>审查与监控:在边缘位置追踪有意义的数据和统计结果,从而带来精确的生产视图.</li><li>动态路由:动态地将请求路由到不同的后端集群</li><li>压力测试:逐渐增加指向集群的流量,以了解性能</li><li>负载分配:为每一种负载类型分配对应容量,并弃用超出限定值的请求.</li><li>静态响应处理:跨越AWS Region进行请求路由,旨在实现ELB(Elastic Load Balancing)使用多样化,以及让系统的边缘更贴近系统的使用者.</li></ul><h4 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h4><ol><li><p>创建工程</p></li><li><p>引入对应依赖</p></li><li><p>添加相关注解</p></li><li><p>添加配置</p><blockquote><p>端口</p><p>路由规则:</p><ul><li>Map结构(id:规则)</li></ul></blockquote></li></ol><h4 id="面向服务的路由配置"><a href="#面向服务的路由配置" class="headerlink" title="面向服务的路由配置"></a>面向服务的路由配置</h4><ol><li><p>在pom.xml引入Eureka的依赖</p></li><li><p>在配置文件中配置相关内容</p><blockquote><p>路由规则:(key:服务的ID,value是映射地址)</p><p>注意:zuul会将注册中心的所有微服务拉取下来在容器内形成映射.</p><p>但如果有的微服务不想对外界暴露则可以通过ignored-services来进行配置.</p></blockquote></li></ol><h4 id="路由前缀"><a href="#路由前缀" class="headerlink" title="路由前缀"></a>路由前缀</h4><p>可以通过配置<code>strip-prefix</code>配置进行路由前缀的配置当值为true时,将会忽略匹配字段</p><p>可以通过<code>prefix</code>进行配置.</p><h4 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h4><p>Suul作为网关的其中一个重要功能,就是实现请求的鉴权.而这个动作我们往往是通过Zuul提供的过滤来实现的.</p><h5 id="ZuulFilter"><a href="#ZuulFilter" class="headerlink" title="ZuulFilter"></a>ZuulFilter</h5><p>ZuulFilter是过滤器的顶级父类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> ZuulFilter implements IZuulFilter&#123;</span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">public</span> String <span class="title">filterOrder</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span></span>;<span class="comment">//来自IZuulFilter</span></span><br><span class="line">    <span class="function">Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException</span>;<span class="comment">//IZuulFilter</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>shouldFilter:返回一个Boolean值,判断该过滤器</li><li>run:过滤器的具体业务逻辑.</li><li>filterType:返回字符串,代表过滤器的类型<ul><li>pre:请求在被路由之前执行</li><li>routing:在路由请求时调用</li><li>post:在routing和error过滤器之后调用</li><li>error:处理请i去是发生错误调用</li></ul></li><li>filterOrder:通过返回的int值来定义过滤器的执行顺序,数字越小优先级越高.</li></ul><h5 id="过滤器执行生命周期"><a href="#过滤器执行生命周期" class="headerlink" title="过滤器执行生命周期"></a>过滤器执行生命周期</h5><ul><li><p>正常流程</p><p>请求到达首先会经过pre类型过滤器,而后到达routing类型,进行路由,请求就到达真正的服务提供者,执行请求,返回结果后,会到达post过滤器.而后返回响应.</p></li><li><p>异常流程</p><p>整个过程中,pre或routing过滤器出现异常,都会直接进入error过滤器,在error处理完毕后,会将请求交给POST过滤器,最后返回给用户.</p><p>如果是error过滤器自己出现异常,最终也会进入POST过滤器,而后返回.</p><p>如果是POST过滤器出现异常,会跳转error过滤器,但是与pre和routing不同的是,请求不会在到达POST过滤器了.</p></li></ul><h5 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h5><p>非常多</p><ul><li>请求鉴权:一般放在pre类型,如果发现没有访问权限,直接拦截</li><li>异常处理:一般凡在error类型和post类型过滤器中结合来处理.</li><li>服务调用时长统计:pre和post结合使用.</li></ul><h4 id="负载均衡和熔断"><a href="#负载均衡和熔断" class="headerlink" title="负载均衡和熔断"></a>负载均衡和熔断</h4><p>Zuul中默认就已经集成了Ribbon负载均衡和Hystix熔断机制.但是所有的超时策略都是走的默认值,比如熔断超时时间只有1S,很容易触发,因此建议手动配置:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">hystrix:</span><br><span class="line">	command:</span><br><span class="line">		default:</span><br><span class="line">			execution:</span><br><span class="line">				isolations:</span><br><span class="line">					thread:</span><br><span class="line">						timeoutInMilliseconds:6000</span><br><span class="line">ribbon:</span><br><span class="line">	ConnectionTimeout:500</span><br><span class="line">	ReadTimeout:2000</span><br></pre></td></tr></table></figure><p>ribbon的超时时长,真实值是(read+connect)*2,必须小于hystrix时长.</p><p>计算公式:</p><blockquote><p>ribbonTimeout = (ribbonReadTimeout+ribbonTimeConnectTimeout)*(maxAutoRetries+1)*(maxAutoRetriesNextServer+1);)</p></blockquote></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 上课睡觉觉</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://robotwuyun.github.io/2020/03/24/学习笔记_SpringCloud_入门/" title="学习笔记_SpringCloud_入门">https://robotwuyun.github.io/2020/03/24/学习笔记_SpringCloud_入门/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/学习笔记/" rel="tag"><i class="fa fa-tag"></i> # 学习笔记</a><a href="/tags/java/" rel="tag"><i class="fa fa-tag"></i> # java</a><a href="/tags/SpringCloud/" rel="tag"><i class="fa fa-tag"></i> # SpringCloud</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2020/03/22/学习笔记_Shell/" rel="next" title="学习笔记_Shell"><i class="fa fa-chevron-left"></i> 学习笔记_Shell</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2020/03/26/采坑指南_Session_1/" rel="prev" title="关于同一浏览器在登录不同用户的Session问题">关于同一浏览器在登录不同用户的Session问题<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <a href="/"><img class="site-author-image" itemprop="image" src="/image/headPic.png" alt="上课睡觉觉"></a><p class="site-author-name" itemprop="name">上课睡觉觉</p><div class="site-description motion-element" itemprop="description">keep learning</div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">79</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">13</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">57</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/RobotWuYun" title="GitHub &rarr; https://github.com/RobotWuYun" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i></a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 推荐阅读</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="http://how2j.cn/" title="http://how2j.cn/" rel="noopener" target="_blank">java</a></li><li class="links-of-blogroll-item"> <a href="http://blog.knownsec.com/Knownsec_RD_Checklist/index.html" title="http://blog.knownsec.com/Knownsec_RD_Checklist/index.html" rel="noopener" target="_blank">知道创宇技能树</a></li></ul></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#SpringCloud"><span class="nav-number">1.</span> <span class="nav-text">SpringCloud</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#系统架构演变"><span class="nav-number">1.0.1.</span> <span class="nav-text">系统架构演变</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#集中式架构"><span class="nav-number">1.0.1.1.</span> <span class="nav-text">集中式架构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#垂直划分"><span class="nav-number">1.0.1.2.</span> <span class="nav-text">垂直划分</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分布式服务"><span class="nav-number">1.0.1.3.</span> <span class="nav-text">分布式服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#流动计算架构-SOA"><span class="nav-number">1.0.1.4.</span> <span class="nav-text">流动计算架构(SOA)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#微服务"><span class="nav-number">1.0.1.5.</span> <span class="nav-text">微服务</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务调用方式"><span class="nav-number">1.0.2.</span> <span class="nav-text">服务调用方式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#RPC和HTTP"><span class="nav-number">1.0.2.1.</span> <span class="nav-text">RPC和HTTP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HTTP客户端工具"><span class="nav-number">1.0.2.2.</span> <span class="nav-text">HTTP客户端工具</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring的RestTemplate"><span class="nav-number">1.0.2.3.</span> <span class="nav-text">Spring的RestTemplate</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始SpringCloud"><span class="nav-number">1.0.3.</span> <span class="nav-text">初始SpringCloud</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#简介"><span class="nav-number">1.0.3.1.</span> <span class="nav-text">简介</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Eureka注册中心"><span class="nav-number">1.0.4.</span> <span class="nav-text">Eureka注册中心</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Eureka做什么"><span class="nav-number">1.0.4.1.</span> <span class="nav-text">Eureka做什么?</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#基本架构"><span class="nav-number">1.0.4.2.</span> <span class="nav-text">基本架构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#高可用的Eureka-Server"><span class="nav-number">1.0.4.3.</span> <span class="nav-text">高可用的Eureka Server</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Eureka客户端"><span class="nav-number">1.0.4.4.</span> <span class="nav-text">Eureka客户端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#失效剔除和自我保护"><span class="nav-number">1.0.4.5.</span> <span class="nav-text">失效剔除和自我保护</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#负载均衡Ribbon"><span class="nav-number">1.0.5.</span> <span class="nav-text">负载均衡Ribbon</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#步骤"><span class="nav-number">1.0.5.1.</span> <span class="nav-text">步骤:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置负载均衡算法"><span class="nav-number">1.0.5.2.</span> <span class="nav-text">配置负载均衡算法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hystrix"><span class="nav-number">1.0.6.</span> <span class="nav-text">Hystrix</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#简介-1"><span class="nav-number">1.0.6.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#雪崩问题"><span class="nav-number">1.0.6.2.</span> <span class="nav-text">雪崩问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#线程隔离-服务降级"><span class="nav-number">1.0.6.3.</span> <span class="nav-text">线程隔离,服务降级</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#原理"><span class="nav-number">1.0.6.3.1.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#步骤-1"><span class="nav-number">1.0.6.3.2.</span> <span class="nav-text">步骤</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务熔断"><span class="nav-number">1.0.6.4.</span> <span class="nav-text">服务熔断</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#熔断原理"><span class="nav-number">1.0.6.4.1.</span> <span class="nav-text">熔断原理</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Feign"><span class="nav-number">1.0.7.</span> <span class="nav-text">Feign</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#步骤-2"><span class="nav-number">1.0.7.1.</span> <span class="nav-text">步骤</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Zuul网关"><span class="nav-number">1.0.8.</span> <span class="nav-text">Zuul网关</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#简介-2"><span class="nav-number">1.0.8.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用方法"><span class="nav-number">1.0.8.2.</span> <span class="nav-text">使用方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#面向服务的路由配置"><span class="nav-number">1.0.8.3.</span> <span class="nav-text">面向服务的路由配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#路由前缀"><span class="nav-number">1.0.8.4.</span> <span class="nav-text">路由前缀</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#过滤器"><span class="nav-number">1.0.8.5.</span> <span class="nav-text">过滤器</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ZuulFilter"><span class="nav-number">1.0.8.5.1.</span> <span class="nav-text">ZuulFilter</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#过滤器执行生命周期"><span class="nav-number">1.0.8.5.2.</span> <span class="nav-text">过滤器执行生命周期</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#使用场景"><span class="nav-number">1.0.8.5.3.</span> <span class="nav-text">使用场景</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#负载均衡和熔断"><span class="nav-number">1.0.8.6.</span> <span class="nav-text">负载均衡和熔断</span></a></li></ol></li></ol></li></ol></div></div></div><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div><script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script><script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script><div class="widget-wrap"><h3 class="widget-title">Tag Cloud</h3><div id="myCanvasContainer" class="widget tagcloud"><canvas width="250" height="250" id="resCanvas" style=""><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ArrayList/">ArrayList</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HashMap/">HashMap</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HelloWorld/">HelloWorld</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IDEA/">IDEA</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IO/">IO</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JDBC/">JDBC</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JDK/">JDK</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JRE/">JRE</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/">JVM</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Junit/">Junit</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LinkedList/">LinkedList</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Log4j/">Log4j</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/">Redis</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Servlet/">Servlet</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Session/">Session</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/">Shell</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/">Spring</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot/">SpringBoot</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringCloud/">SpringCloud</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringMVC/">SpringMVC</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/">Tomcat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Typora/">Typora</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/">Vue</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/">go</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a><span class="tag-list-count">35</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lombok/">lombok</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/markdown/">markdown</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/">maven</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/">nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端/">前端</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/博客/">博客</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/反射机制/">反射机制</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/变量/">变量</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/后端/">后端</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/学习笔记/">学习笔记</a><span class="tag-list-count">49</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/异常处理/">异常处理</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/控制流程/">控制流程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/操作符/">操作符</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/教程/">教程</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数字与字符串/">数字与字符串</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数组/">数组</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/日期/">日期</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/泛型/">泛型</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/注解/">注解</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/笔记/">笔记</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/类和对象/">类和对象</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/线程/">线程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/练手项目/">练手项目</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/继承与接口/">继承与接口</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/读书笔记/">读书笔记</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/资源/">资源</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/集合框架/">集合框架</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/面向对象/">面向对象</a><span class="tag-list-count">1</span></li></ul></canvas></div></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2020</span><span class="with-love" id="animate"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">上课睡觉觉</span> <span class="post-meta-divider">|</span><div class="theme-info"><div class="powered-by"></div> <span class="post-count">博客全站共161.6k字</span> <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span><br></div><script>var now=new Date;function createtime(){var n=new Date("6/4/2019 12:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML=" Runing "+dnum+" D ",document.getElementById("times").innerHTML=hnum+" H "+mnum+" M "+snum+" S"}setInterval("createtime()",250)</script><br></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="访客"><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div></div></footer></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/js/utils.js?v=7.1.2"></script><script src="/js/motion.js?v=7.1.2"></script><script src="/js/affix.js?v=7.1.2"></script><script src="/js/schemes/pisces.js?v=7.1.2"></script><script src="/js/scrollspy.js?v=7.1.2"></script><script src="/js/post-details.js?v=7.1.2"></script><script src="/js/next-boot.js?v=7.1.2"></script><script src="//cdn1.lncld.net/static/js/3.11.1/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>var GUEST=["nick","mail","link"],guest="nick,mail,link";guest=guest.split(",").filter(function(e){return-1<GUEST.indexOf(e)}),new Valine({el:"#comments",verify:!0,notify:!0,appId:"307oukv7PLH0lFI21FdIyLQN-gzGzoHsz",appKey:"OxpbXXBsre8puGriAb0RuF3Y",placeholder:"欢迎交流讨论...",avatar:"mm",meta:guest,pageSize:"10",visitor:!1,lang:"zh-cn"})</script><script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script>
    
    function addCount(Counter) {
      var $visitors = $('.leancloud_visitors');
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url }) })
        .done(function({ results }) {
          if (results.length > 0) {
            var counter = results[0];
            
            Counter('put', '/classes/Counter/' + counter.objectId, JSON.stringify({ time: { '__op': 'Increment', 'amount': 1 } }))
            
              .done(function() {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.time + 1);
              })
            
              .fail(function ({ responseJSON }) {
                console.log('Failed to save Visitor num, with error message: ' + responseJSON.error);
              })
          } else {
            
              var $element = $(document.getElementById(url));
              $element.find('.leancloud-visitors-count').text('Counter not initialized! More info at console err msg.');
              console.error('ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.');
            
          }
        })
        .fail(function ({ responseJSON }) {
          console.log('LeanCloud Counter Error: ' + responseJSON.code + ' ' + responseJSON.error);
        });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + '')
        .done(function({ api_server }) {
          var Counter = function(method, url, data) {
            return $.ajax({
              method: method,
              url: 'https://' + api_server + '/1.1' + url,
              headers: {
                'X-LC-Id': '',
                'X-LC-Key': '',
                'Content-Type': 'application/json',
              },
              data: data
            });
          };
          
            addCount(Counter);
          
        });
    });
  </script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/koharu.model.json"},display:{position:"right",width:150,height:300},mobile:{show:!0},log:!1})</script></body></html>